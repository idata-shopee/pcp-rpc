package io.github.shopee.idata.pcprpc

import io.github.shopee.idata.taskqueue.TimeoutScheduler
import io.github.shopee.idata.pcp.{ BoxFun, CallResult, PcpClient, PcpServer, Sandbox }
import java.net.InetSocketAddress
import io.github.shopee.idata.sjson.JSON
import scala.concurrent.ExecutionContext.Implicits.global
import scala.concurrent.{ Await, Future, Promise, duration }
import duration._
import scala.io

class PracticeTest extends org.scalatest.FunSuite {
  val BIG_STRING = s"""
  {"id":"3389a835-112c-4753-b161-34b39c6e3ad9","ctype":"purecall-response","data":{"text":{"headers":["Product View","Item ID","shop_name","Item Name","username","Level3 Category","item_stock","userid","Impression","Numbers of Likes","Main Category","Sub Category","Item GMV","shopid","Latest Item Discount Rate","is_official_store"],"data":[{"Product View":51,"Item ID":1542930301,"shop_name":"ABCæ—¥è²¨ä»£è³¼","Item Name":"ã€é™é‡ç‰¹åƒ¹ã€‘ã€æžœå¯¦30%å¢žé‡æ¬¾ã€‘æ—¥æ¸…ç‡•éº¥ç‰‡ æ—¥æ¸…æ—©é¤è„†ç‰‡ æ—¥æ¸… å¥¢ä¾ˆæžœå¯¦ è‰èŽ“ å¤§åŒ…è£ 500g æ°´æžœç‡•éº¥è„†ç‰‡ ç‡•éº¥è„†ç‰‡","username":"johnson75","Level3 Category":"Oatmeal & Cereals","item_stock":25,"userid":18026518,"Impression":993,"Numbers of Likes":2,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":18025182,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":2,"Item ID":114880885,"shop_name":"yangshuhsiu","Item Name":"ç¾Žéº—æ¨‚ å³æº¶è±†æ­Œ","username":"yangshuhsiu","Level3 Category":"Oatmeal & Cereals","item_stock":5,"userid":1575925,"Impression":0,"Numbers of Likes":0,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":1574762,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":81,"Item ID":1161431294,"shop_name":"AJ æ—¥éŸ“å°èˆ–","Item Name":"ã€AJæ—¥éŸ“å°èˆ–ã€‘æ—¥æœ¬ æ—¥æ¸… Nissin BIG æ—©é¤çŽ‰ç±³ç‰‡ 220g (å¤šæ¬¾å¯é¸) -TC","username":"aj1728","Level3 Category":"Oatmeal & Cereals","item_stock":600,"userid":12111458,"Impression":1527,"Numbers of Likes":15,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":12110156,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":134,"Item ID":1079285325,"shop_name":"â­ï¸å¹³éŠ˜å°èˆ–â­ï¸","Item Name":"â­ï¸å¹³éŠ˜å°èˆ–â­ï¸500g å½©è™¹è—œéº¥ 1:1:1 ä¸‰è‰²è—œéº¥ å¤šé …æª¢é©—å ±å‘Š é»‘è—œéº¥ ç´…è—œéº¥ ç™½è—œéº¥","username":"qaz388388","Level3 Category":"Oatmeal & Cereals","item_stock":3700,"userid":3020599,"Impression":1953,"Numbers of Likes":34,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":1039.7993297025555,"shopid":3019312,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":1,"Item ID":882847130,"shop_name":"å°ç£åˆè¿·é›…å¥½ç‰©å•†åŸŽ","Item Name":"æ¡‚æ ¼ä¸‰åˆä¸€éº¥ç‰‡-ä½Žç³–10åŒ…å…¥ã€å°ç£åˆè¿·é›…å¥½ç‰©å•†åŸŽã€‘","username":"didimai0918","Level3 Category":"Oatmeal & Cereals","item_stock":100,"userid":4798293,"Impression":45,"Numbers of Likes":1,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":4797003,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":6,"Item ID":1465997259,"shop_name":"æ±æ´‹æžœå­åº—ã€Šæ…¶æ˜Œè¡Œã€‹","Item Name":"ã€æ±æ´‹æžœå­åº—ã€‘ç¶­å‰æ€ è‘¡è„ç©€ç‰©è„†æžœ(170g) ï¼Žç¾Žåœ‹åŽŸè£é€²å£ï¼Ž850529004467","username":"phoenix63226","Level3 Category":"Oatmeal & Cereals","item_stock":88,"userid":8255609,"Impression":154,"Numbers of Likes":0,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":8254313,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":18,"Item ID":1751178490,"shop_name":"é¤Šç”Ÿå ‚ä¸­è—¥è¡Œ","Item Name":"ã€é¤Šç”Ÿå ‚ã€‘å°éº¥çº–ç¶­ é«”å…§ç’°ä¿ æŽ’ä¾¿é †æš¢ é¤Šé¡ç¾Žï¿½ï¿½ ã€Šç¾è²¨ã€‹","username":"kani0520","Level3 Category":"Oatmeal & Cereals","item_stock":14,"userid":17665810,"Impression":222,"Numbers of Likes":0,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":17664474,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":7,"Item ID":72773760,"shop_name":"è–èª•ç‰¹è³£ æ­¡æ…¶2019","Item Name":"~åŒ—åœ‹é™æ™‚ç‰¹è³£!æ—¥æœ¬ä¸Šç­æ—olå¿…å‚™å“~ elekiæ˜“åˆ©æ°£ ç£åŠ›è‚©å¸¶ç£çŸ³ æ°¸ä¹…ç£çŸ³è‚©å¸¶ æ­é…é …åœˆæ›´å¥½ç”¨","username":"foolchenyuwen","Level3 Category":"Oatmeal & Cereals","item_stock":5,"userid":4854102,"Impression":294,"Numbers of Likes":35,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":4852812,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":5,"Item ID":1660778026,"shop_name":"fuaseangrocery","Item Name":"ENERGEN CEREAL DRINK CHOCOLATE 30g","username":"ootdbyirenefu","Level3 Category":"Oatmeal & Cereals","item_stock":19,"userid":61661941,"Impression":146,"Numbers of Likes":2,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":61660499,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":0,"Item ID":47920783,"shop_name":"èµ°èµ°çœ‹çœ‹å°±å¥½","Item Name":"æ¼¢èŽ«å¯§-ç¶œåˆç©€éº¥ç‰‡300g","username":"sup9982003","Level3 Category":"Oatmeal & Cereals","item_stock":99,"userid":126976,"Impression":6,"Numbers of Likes":0,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":126975,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":1,"Item ID":1646207621,"shop_name":"WelcomeLALALA","Item Name":"è‰¾å¤šç¾Ž ç¶œåˆç©€ç‰©é£² 30å…¥","username":"chengi1021","Level3 Category":"Oatmeal & Cereals","item_stock":9,"userid":21053628,"Impression":49,"Numbers of Likes":2,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":21052292,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":5,"Item ID":256868027,"shop_name":"3Qè³¼","Item Name":"è–Œåœ’ é»‘èŠéº»ç²‰(ç†Ÿç²‰)  (400å…¬å…‹/å¤¾éˆè¢‹è£)","username":"s3qgo","Level3 Category":"Oatmeal & Cereals","item_stock":656,"userid":21818900,"Impression":135,"Numbers of Likes":6,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":21817564,"Latest Item Discount Rate":0,"is_official_store":1},{"Product View":36,"Item ID":410706538,"shop_name":"èŒ¹ç´ é¤è±-ç´ è³¼ç¶² (è®“æ‚¨åƒç´ é¤é¤éƒ½è±å¯Œ)","Item Name":"ã€èŒ¹ç´ é¤è±ã€‘å°šç·£çŽ‰ç±³æ¿ƒæ¹¯(å¥¶ç´ )32gX10åŒ…å…¥ çŽ‰ç±³æ¿ƒæ¹¯ å…·æœ‰é¦™æ¿ƒèˆ‡é¦™ç”œæ»‘é †çš„å£æ„Ÿï¼Œä»¥å¤©ç„¶é£Ÿæç ”è£½è€Œæˆï¼Œç‡Ÿé¤Šåˆå¯å£ï¼","username":"rusucfmall","Level3 Category":"Oatmeal & Cereals","item_stock":52,"userid":22266710,"Impression":533,"Numbers of Likes":34,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":139.04761904761904,"shopid":22265374,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":86,"Item ID":1653605529,"shop_name":"chiou0972","Item Name":"costco ä»£è³¼ æ¡‚æ ¼é»ƒé‡‘éº¥èŠ½ä¸‰åˆä¸€éº¥ç‰‡","username":"chiou0972","Level3 Category":"Oatmeal & Cereals","item_stock":3,"userid":12220565,"Impression":396,"Numbers of Likes":1,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":2424.0,"shopid":12219263,"Latest Item Discount Rate":0,"is_official_store":0},{"Product View":0,"Item ID":1141670510,"shop_name":"ã€å–«å¥åº·ã€‘æœ‰æ©Ÿå¥åº·ä¾¿åˆ©è³¼","Item Name":"ã€å–«å¥åº·ã€‘å°ç£ç¶ æºå¯¶ç‡Ÿé¤Šçå‘³æä»ç‡•éº¥å¥¶(500g)/è²·6ç“¶å¯å…é‹","username":"eathealthy41","Level3 Category":"Oatmeal & Cereals","item_stock":36,"userid":67578477,"Impression":64,"Numbers of Likes":0,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":0.0,"shopid":67577020,"Latest Item Discount Rate":0,"is_official_store":0}],"count":9316},"errno":0,"errMsg":""}}
  """
  val BIG_STRING2 = s"""
  {"id":"a9fe0117-a72f-437e-b09f-c0b3ad08b399","ctype":"purecall-response","data":{"text":{"headers":["Item ID","shop_name","Item Name","username","Level3 Category","item_stock","userid","Impression","Numbers of Likes","Latest Item Price","Main Category","Sub Category","Item GMV","shopid","Latest Item Discount Rate"],"data":[{"Item ID":1247404776,"shop_name":"æŒ‘é£Ÿå±‹PIKIYA-æ—¥æœ¬é€²å£é£Ÿå“å°ˆè³£","Item Name":"ã€Kasugaiæ˜¥æ—¥äº•ã€‘é‡‘å¹³ç³– 140g æ—¥æœ¬é€²å£ç³–æžœ æŒ‘é£Ÿå±‹","username":"pikiyashop","Level3 Category":"Candy & Chocolate","item_stock":6,"userid":2066177,"Impression":151,"Numbers of Likes":0,"Latest Item Price":89.0,"Main Category":"Food & Beverages","Sub Category":"Snacks","Item GMV":0.0,"shopid":2064665,"Latest Item Discount Rate":18},{"Item ID":101549187,"shop_name":"è²“å’ªå§å¦¹ æ—¥æœ¬ä»£è³¼ðŸ‡¯ðŸ‡µ","Item Name":"æ—¥æœ¬ NISSIN æ—¥æ¸… Choco Flakes å¯å¯çŽ‰ç±³å·§å…‹åŠ›è„†ç‰‡(90g) å¯å¯è„†ç‰‡ å¯å¯å·§å…‹åŠ›","username":"ruby03060306","Level3 Category":"Japanese Snacks","item_stock":7,"userid":1913089,"Impression":556,"Numbers of Likes":67,"Latest Item Price":60.0,"Main Category":"Food & Beverages","Sub Category":"Imported Snacks","Item GMV":312.2116689280868,"shopid":1911696,"Latest Item Discount Rate":0},{"Item ID":32132058,"shop_name":"å‘³æ—…Spices Journey - é¦™è¾›æ–™å°ˆè³£åº—","Item Name":"ã€å‘³æ—…åš´é¸ã€‘ï½œç™½èƒ¡æ¤’ç²’ï½œ100g","username":"bkyang","Level3 Category":"Sauces & Seasonings","item_stock":92,"userid":6193666,"Impression":572,"Numbers of Likes":101,"Latest Item Price":100.0,"Main Category":"Food & Beverages","Sub Category":"Baking & Grocery","Item GMV":616.21014818141,"shopid":6192359,"Latest Item Discount Rate":0},{"Item ID":1818911512,"shop_name":"è²“å’ªå§å¦¹ æ—¥æœ¬ä»£è³¼ðŸ‡¯ðŸ‡µ","Item Name":"æ—¥æœ¬ glico æ ¼åŠ›é«˜ å›ºåŠ›æžœ è‰èŽ“æ²å¿ƒé¤… ç‰›ä¹³æ²å¿ƒé¤… è‰èŽ“å¤¾å¿ƒæ² ç‰›ä¹³é¤…ä¹¾ æ—¥æœ¬é›¶é£Ÿ é€²å£é›¶é£Ÿ","username":"ruby03060306","Level3 Category":"Japanese Snacks","item_stock":34,"userid":1913089,"Impression":366,"Numbers of Likes":2,"Latest Item Price":85.0,"Main Category":"Food & Beverages","Sub Category":"Imported Snacks","Item GMV":0.0,"shopid":1911696,"Latest Item Discount Rate":0},{"Item ID":1670953003,"shop_name":"æŒ‘é£Ÿå±‹PIKIYA-æ—¥æœ¬é€²å£é£Ÿå“å°ˆè³£","Item Name":"ã€Nissinæ—¥æ¸…ã€‘UFOäº”ç›®é†¬æ²¹æµ·é®®ç‚’éºµ å³é£Ÿç¢—éºµ114gæ—¥æœ¬é€²å£æ³¡éºµ æŒ‘é£Ÿå±‹","username":"pikiyashop","Level3 Category":"Instant Noodle","item_stock":3,"userid":2066177,"Impression":952,"Numbers of Likes":4,"Latest Item Price":99.0,"Main Category":"Food & Beverages","Sub Category":"Rice & Noodles","Item GMV":0.0,"shopid":2064665,"Latest Item Discount Rate":20},{"Item ID":56825126,"shop_name":"è²“å’ªå§å¦¹ æ—¥æœ¬ä»£è³¼ðŸ‡¯ðŸ‡µ","Item Name":"æ—¥æœ¬ä¸€æ¦®é­·é­šçµ² å¢¨é­šçµ²é±ˆé­šé¦™çµ²å–®åŒ…(6g)ã€è²“å’ªå§å¦¹ä»£è³¼ã€‘é­·é­šçµ² é±ˆé­šçµ²","username":"ruby03060306","Level3 Category":"Japanese Snacks","item_stock":74,"userid":1913089,"Impression":1731,"Numbers of Likes":152,"Latest Item Price":10.0,"Main Category":"Food & Beverages","Sub Category":"Imported Snacks","Item GMV":424.40692877032006,"shopid":1911696,"Latest Item Discount Rate":0},{"Item ID":1625531861,"shop_name":"å—æ¦®xPickUpToU","Item Name":"ã€ç¾©ç¾Žã€‘å·§å…‹åŠ›é…¥ç‰‡ ä¸€çµ„2åŒ…å…¥","username":"chianichilu","Level3 Category":"Traditional Snacks","item_stock":22,"userid":2931182,"Impression":534,"Numbers of Likes":6,"Latest Item Price":30.0,"Main Category":"Food & Beverages","Sub Category":"Snacks","Item GMV":29.223300970873787,"shopid":2929807,"Latest Item Discount Rate":0},{"Item ID":26418415,"shop_name":"è²“å’ªå§å¦¹ æ—¥æœ¬ä»£è³¼ðŸ‡¯ðŸ‡µ","Item Name":"æ—¥æœ¬ Kracie çŸ¥è‚²æžœå­ DIYè‡ªå·±å‹•æ‰‹åš é£ŸçŽ© æ¼¢å ¡é£ŸçŽ© å£½å¸é£ŸçŽ© é¯›é­šä¸¸å­ å£½å¸ å†°æ·‡æ·‹ å¸ƒä¸ å¤æ—¥æ…¶å…¸","username":"ruby03060306","Level3 Category":"Japanese Snacks","item_stock":84,"userid":1913089,"Impression":2531,"Numbers of Likes":640,"Latest Item Price":99.0,"Main Category":"Food & Beverages","Sub Category":"Imported Snacks","Item GMV":3061.9923954372625,"shopid":1911696,"Latest Item Discount Rate":10},{"Item ID":85407364,"shop_name":"è²“å’ªå§å¦¹ æ—¥æœ¬ä»£è³¼ðŸ‡¯ðŸ‡µ","Item Name":"æ—¥æœ¬ UHAå‘³è¦ºç³– å™—å•¾ç³–æžœ è˜‡æ‰“è—èŽ“è‘¡è„ï¿½ï¿½ï¿½å¿ƒè»Ÿç³– (98g) å“ˆå¯†ç“œè˜‡æ‰“è»Ÿç³– é’è˜‹æžœè˜‡æ‰“ è‰èŽ“è»Ÿç³– è˜‡æ‰“è»Ÿç³– é³³æ¢¨è»Ÿç³–","username":"ruby03060306","Level3 Category":"Japanese Snacks","item_stock":90,"userid":1913089,"Impression":575,"Numbers of Likes":95,"Latest Item Price":79.0,"Main Category":"Food & Beverages","Sub Category":"Imported Snacks","Item GMV":0.0,"shopid":1911696,"Latest Item Discount Rate":0},{"Item ID":78966669,"shop_name":"å‘³æ—…Spices Journey - é¦™è¾›æ–™å°ˆè³£åº—","Item Name":"ã€å‘³æ—…åš´é¸ã€‘ï½œå±±è‰¾ç²‰ï½œ50g/100g","username":"bkyang","Level3 Category":"Sauces & Seasonings","item_stock":197,"userid":6193666,"Impression":151,"Numbers of Likes":11,"Latest Item Price":70.0,"Main Category":"Food & Beverages","Sub Category":"Baking & Grocery","Item GMV":0.0,"shopid":6192359,"Latest Item Discount Rate":0},{"Item ID":1101840765,"shop_name":"æŒ‘é£Ÿå±‹PIKIYA-æ—¥æœ¬é€²å£é£Ÿå“å°ˆè³£","Item Name":"ã€å¯å£å¯æ¨‚ã€‘æœŸé–“é™å®šCoca-Colaé‹ç“¶è£åŽŸå‘³å¯æ¨‚ 250ml æ”¶è—ç‰ˆ æ—¥æœ¬åŽŸè£é€²å£","username":"pikiyashop","Level3 Category":"Drink","item_stock":15,"userid":2066177,"Impression":375,"Numbers of Likes":10,"Latest Item Price":75.0,"Main Category":"Food & Beverages","Sub Category":"Beverage","Item GMV":94.23076923076924,"shopid":2064665,"Latest Item Discount Rate":24},{"Item ID":62566073,"shop_name":"è²“å’ªå§å¦¹ æ—¥æœ¬ä»£è³¼ðŸ‡¯ðŸ‡µ","Item Name":"æ—¥æœ¬æ˜¥æ—¥äº•KASUGAIèŠ¥æœ«å‘³è„†çš®é’è±Œè±†(80g)","username":"ruby03060306","Level3 Category":"Dried Fruit & Nuts","item_stock":22,"userid":1913089,"Impression":357,"Numbers of Likes":18,"Latest Item Price":65.0,"Main Category":"Food & Beverages","Sub Category":"Snacks","Item GMV":68.85185185185185,"shopid":1911696,"Latest Item Discount Rate":0},{"Item ID":1712439598,"shop_name":"æŒ‘é£Ÿå±‹PIKIYA-æ—¥æœ¬é€²å£é£Ÿå“å°ˆè³£","Item Name":"ã€ä¸‰å¹¸è£½è“ã€‘æœŸé–“é™å®š é›ªå®¿ç‰›å¥¶ç±³æžœ-ç”˜é…’é¢¨å‘³ 22æžšå…¥ 145.2g æ—¥æœ¬é€²å£é›¶é£Ÿ","username":"pikiyashop","Level3 Category":"Japanese Snacks","item_stock":3,"userid":2066177,"Impression":181,"Numbers of Likes":0,"Latest Item Price":89.0,"Main Category":"Food & Beverages","Sub Category":"Imported Snacks","Item GMV":0.0,"shopid":2064665,"Latest Item Discount Rate":25},{"Item ID":13699942,"shop_name":"å—æ¦®xPickUpToU","Item Name":"HAMADAéˆ£è³ªå¨åŒ–é¤… ä¸€çµ„3å…¥","username":"chianichilu","Level3 Category":"Cookies & Potato Chips & Popcorn","item_stock":37,"userid":2931182,"Impression":216,"Numbers of Likes":38,"Latest Item Price":20.0,"Main Category":"Food & Beverages","Sub Category":"Snacks","Item GMV":0.0,"shopid":2929807,"Latest Item Discount Rate":0},{"Item ID":345973797,"shop_name":"ï¿½ï¿½å’ªå§å¦¹ æ—¥æœ¬ä»£è³¼ðŸ‡¯ðŸ‡µ","Item Name":"æ—¥æœ¬ YAMAKI äºžåª½å‰ èŒ¶ç¢—è’¸é°¹é­šæ˜†å¸ƒé«˜æ¹¯(45ml)","username":"ruby03060306","Level3 Category":"Sauces & Seasonings","item_stock":16,"userid":1913089,"Impression":769,"Numbers of Likes":40,"Latest Item Price":35.0,"Main Category":"Food & Beverages","Sub Category":"Baking & Grocery","Item GMV":92.97619047619047,"shopid":1911696,"Latest Item Discount Rate":36}],"count":753},"errno":0,"errMsg":"}}
  """
  val sandbox = new Sandbox(
    Map[String, BoxFun](
      // define add function
      "bigString" -> Sandbox.toSanboxFun((params: List[Any], pcs: PcpServer) => {
        BIG_STRING
      }),
      "bigString2" -> Sandbox.toSanboxFun((params: List[Any], pcs: PcpServer) => {
        BIG_STRING2
      })
    )
  )

  test("string with special chars1") {
    val server = PcpRpc.getPCServer(sandbox = sandbox)
    val pool = PcpRpc.getPCClientPool(
      getServerAddress = () => Future { PcpRpc.ServerAddress(port = server.getPort()) }
    )

    try {
      val p = new PcpClient()
      Await.result(pool.call(p.call("bigString")) map { result =>
        assert(result == BIG_STRING)
      }, 15.seconds)
    } finally {
      server.close()
    }
  }

  test("string with special chars2") {
    val server = PcpRpc.getPCServer(sandbox = sandbox)
    val pool = PcpRpc.getPCClientPool(
      getServerAddress = () => Future { PcpRpc.ServerAddress(port = server.getPort()) }
    )

    try {
      val p = new PcpClient()
      Await.result(pool.call(p.call("bigString2")) map { result =>
        assert(result == BIG_STRING2)
      }, 15.seconds)
    } finally {
      server.close()
    }
  }
}